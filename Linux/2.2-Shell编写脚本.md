> Create by **fall** on 11/22/2022
> Recently revised in 01/03/2023

# 脚本文件

## 使用

比如，可以用于书写批量执行的脚本，或者是 `npm` 中的脚本（node_modules 下的 `.bin` 目录中，有三类脚本）

首行内容固定，以 `#!` 开始，称为 shebang 指令，用于指定运行该脚本的解析器。

命名一个 bash 脚本：`hello.sh`，并在脚本内填写以下内容

```bash
#!/bin/sh
VAR="world"
echo "Hello $VAR"
```

```bash
$ bash hello.sh
```

输出内容为：`Hello world`

### 注释

```bash
# 这是一个内联 Bash 注释
# 多行注释中冒号，空格，引号，缺一不可。
: '
这是 bash 多行注释
bash echo
'
```

## 变量

```bash
NAME="Fall"     # 注意：赋值符号前后均不能有空格
echo ${NAME}    # => Fall (变量)
echo $NAME      # => Fall (变量)
echo "$NAME"    # => Fall (变量)
echo '$NAME'    # => $NAME (字符串原样输出) 单引号和双引号不同
echo "${NAME}!" # => Fall! (变量)
```

变量的作用域可以分成三类：

- **环境变量**：能在当前 shell 及其子 shell 中使用，使用 `declare -x` 或 `export` 导出。
- **全局变量**：只能在当前 shell 进程内使用，默认。
- **局部变量**：只能在函数内使用，使用命令 `local` 声明。

变量除了保存值以外，还可能绑定某些属性，比如 只读、只能存储数值、作用域。

`declare` 命令可以赋予变量一些特殊的属性。

```bash
declare -r CONST_INT=2 # 设置只读变量，同 readonly 命令声明的变量
declare -i a_int=3 # 数字类型变量
declare -x ENV_VAR=value # 设置为环境变量
```

尽管这看起来像是变量声明，不过也可以作用于已有变量。

```bash
var=val
declare -r var
```

### 默认参数

系统提供了一些默认参数提供调用

| 表示        | 描述                                         |
| ----------- | -------------------------------------------- |
| `$0`        | 脚本本身的名称                               |
| `$1` … `$9` | 参数 1 ... 9                                 |
| `${10}`     | 位置参数 10                                  |
| `$#`        | 参数数量                                     |
| `$$`        | shell 的进程 id                              |
| `$*`        | 所有参数                                     |
| `$@`        | 所有参数，从第一个开始                       |
| `$-`        | 当前选项                                     |
| `$_`        | 上一个命令的最后一个参数                     |
| `$?`        | 上一个命令的执行结果，`0` 为成功，其他为失败 |

假设有如下脚本 `test`

```bash
#!/bin/sh
pink="Ori ddd"
echo $pink
echo $(pwd)
echo $0
echo $1
echo $*
```

我们通过该方式执行

```bash
# 执行该命令
bash test -g -m
# 得到输出为
# Ori ddd
# /e/Full-stuck-study/命令行
# test.sh
# -g
# -g -m
```

### 参数扩展

| 代码              | 描述             |
| ----------------- | ---------------- |
| `${FOO%suffix}`   | 删除后缀         |
| `${FOO#prefix}`   | 删除前缀         |
| `${FOO%%suffix}`  | 去掉长后缀       |
| `${FOO##prefix}`  | 删除长前缀       |
| `${FOO/from/to}`  | 替换第一个匹配项 |
| `${FOO//from/to}` | 全部替换         |
| `${FOO/%from/to}` | 替换后缀         |
| `${FOO/#from/to}` | 替换前缀         |

| 表示            | 描述                |
| --------------- | ------------------- |
| `${FOO:0:3}`    | 子串 *(位置，长度)* |
| `${FOO:(-3):3}` | 从右边开始的子串    |
| `${#FOO}`       | 参数 FOO 的长度     |

| 表示      | 描述          |
| --------- | ------------- |
| `${#FOO}` | `$FOO` 的长度 |

```bash
pink="what"
echo ${#pink} # 4
```



## 函数

定义函数

```bash
#!/bin/sh
pink="Ori"
get_name() {
  echo "John ${pink}"
}
echo "You are $(get_name)"
# 执行结果
# You are John 执行结果 
```

其中，函数的定义也可以写为

```bash
function get_name(){
	echo "John $pink"
}
# 函数的执行必须通过 $() 或者 `` 进行包裹
$(get_name)
`get_name`
# 二者等价
```

## 命令替换

```bash
#!/bin/sh
# 如果想要执行一些命令，可以使用 `command` $(command) 使用命令 command 可替换
echo `pwd` # 等同于 $(pwd)
# 输出：
# /e/Full-stuck-study/命令行
echo "where am i $(pwd)"
echo "where am i `pwd`"
```

### 条件句

```bash
#!/bin/sh
string="wtf"
# string="" # 为空时，也为 false
if [ -z "$string" ]; then
    echo "String is empty"
elif [ -n "$string" ]; then
    echo "String is not empty"
fi
```

见：[条件句](#bash-条件句)

## 大括号扩展

```shell
echo {A,B}
# A B
echo {A,B}.js
# A.js B.js
{1..5}
# 1 2 3 4 5
{A..F}
# A B C D E F
```

### 默认值

| 表示              | 描述                                 |
| ----------------- | ------------------------------------ |
| `${FOO:-val}`     | `$FOO`，如果未设置，则为 `val`       |
| `${FOO:=val}`     | 如果未设置，则将 `$FOO` 设置为 `val` |
| `${FOO:+val}`     | `val` 如果设置了`$FOO`               |
| `${FOO:?message}` | 如果 `$FOO` 未设置，则显示消息并退出 |


## 参考文章

| 作者       | 链接                                                         |
| ---------- | ------------------------------------------------------------ |
| jaywcjlove | https://github.com/jaywcjlove/reference/blob/main/docs/bash.md |
| czpcalm    | https://juejin.cn/post/7130983293347954718                   |
| czpcalm    | https://juejin.cn/post/7130982053528469511                   |

