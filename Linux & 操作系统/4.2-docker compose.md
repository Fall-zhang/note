> Create by **fall** on 24 Jul 2023
> Recently revised in 24 Jul 2023

## docker-compose

如果将配置全在命令行里书写，不容易保存，且一次只能生成一个容器，修改和查找上下文也不方便。

以 docker-compose 来运行命令，可以解决上面的问题。即，通过一个 `docker-compose.yml` 文件生成多个容器。

- `docker-compose up` 启动运行内容

| **配置项**      | **描述**                                                     |
| --------------- | ------------------------------------------------------------ |
| **version**     | 指定 Docker Compose 的版本号                                 |
| **services**    | 定义各个服务（即容器）的配置，可以指定每个服务的镜像、容器名称、启动命令、端口映射、环境变量等。 |
| **networks**    | 定义各个网络的配置，常见的如 bridge、host、overlay 等        |
| **volumes**     | 定义各个数据卷的配置，可以指定数据卷的类型、名称、挂载目录等。 |
| **build**       | 指定 Dockerfile 的路径或者一个 URL，用于构建镜像。           |
| **image**       | 指定镜像的名称或者 ID，用于拉取或者使用一个已经存在的镜像。  |
| **ports**       | 指定容器内部端口和主机端口之间的映射关系。                   |
| **environment** | 指定容器的环境变量。                                         |
| **depends_on**  | 指定容器之间的依赖关系，如谁依赖谁，启动顺序等。             |
| **command**     | 指定容器启动时要运行的命令。                                 |
| **restart**     | 指定容器在出现故障时应该如何重新启动。常见的配置如，always   |
| **healthcheck** | 定义容器的健康检查。                                         |
| **deploy**      | 指定服务在 Docker Swarm 中的部署配置。                       |
| **secrets**     | 指定容器中使用的加密密钥和证书等。                           |
| **configs**     | 指定容器中使用的配置文件。                                   |

### 完整配置示例

```yml
version: '3'
services:
  app:
    image: node:18-alpine # 镜像名称以及版本
    restart: always  # 重启 docker 后该容器也重启
    command: sh -c "yarn install && yarn run dev"
    ports:
      - 127.0.0.1:3000:3000
    working_dir: /app
    volumes:
      - ./:/app
    environment:
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: secret
      MYSQL_DB: todos

  mysql:
    image: mysql:8.0
    volumes:
      - todo-mysql-data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: secret
      MYSQL_DATABASE: todos

volumes:
  todo-mysql-data:
```



```yaml
services:
  mysql:
    image: mysql:5.7.35 
    container_name: mysql # 容器名称
    environment:
      MYSQL_ROOT_PASSWORD: 123456 # 指定用户密码
      TZ: Asia/Shanghai
    ports:
      - 3306:3306 #本地端口号与容器内部端口号
    volumes: #指定挂载目录
      - /usr/etc/mysql/datadir:/var/lib/mysql
      - /usr/etc/mysql/config/my.cnf:/etc/mysql/my.cnf
    command: 
      --max_connections=1000
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_general_ci
      --default-authentication-plugin=mysql_native_password
  redis:
    image: redis:4.0.7  #镜像名称以及版本
    restart: always  #重启docker后该容器也重启
    container_name: redis #容器名称
    ports:
      - 6379:6379 #本地端口号与容器内部端口号
    volumes: #指定挂载目录
      - /usr/etc/redis/redis.conf:/usr/local/etc/redis/redis.conf  #redis.conf文件和data目录分别映射了主机的redis.conf文件和主机的data目录
      - /usr/etc/redis/data:/data
    command:
      /bin/bash -c "redis-server /usr/local/etc/redis/redis.conf " #使用command可以覆盖容器启动后默认执行的命令。这里启动执行指定的redis.conf文件
  nginx:
    image: nginx:1.21.3 #镜像名称以及版本
    restart: always #重启docker后该容器也重启
    container_name: nginx #容器名称
    ports:
      - 80:80 #本地端口号与容器内部端口号
      - 443:443 #本地端口号与容器内部端口号
    volumes: #指定挂载目录
      - ./usr/etc/nginx/html:/usr/share/nginx/html
      - ./usr/etc/nginx/log:/var/log/nginx
      - ./usr/etc/nginx/conf:/etc/nginx/
```




### 自动化部署

使用 `docker` + `jenkins` 能实现代码提交到 github 后自动部署环境

- `docker login` 进行登录
- `docker login -u username` 指定用户名称
- `docker push username/image-name` 将镜像推送到 docker hub



## 应用的使用

### Mongo

```yaml
services:
	mongo:
    restart: always
    image: mongo:4.2.24
    volumes:
      - ./data:/data/db
    networks:
      - express-mongo
    expose:
      - 27017
```





## 参考文章

| 作者         | 文章名称                                                     |
| ------------ | ------------------------------------------------------------ |
| 爱笑的架构师 | [5分钟带你快速了解Docker和k8s](https://juejin.cn/post/6913568633813729294) |
|              |                                                              |
|              |                                                              |
| 天行无忌     | [WEB开发人员应该知道 10 个 Docker 命令](https://juejin.cn/post/7188341548692537402) |
|              |                                                              |
| 官方文档     | https://docs.docker.com/get-started/02_our_app/              |
| 佳庆         | [docker-compose讲解与安装](https://juejin.cn/post/7220730324752859195) |
|              |                                                              |

