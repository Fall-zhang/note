---
sidebar_position: 30
---

>Create by **fall** on 2021-09-22
>Recently revised in 2022-01-27

## 文件处理

前端的文件处理包括，上传，类型检查，文件类型转换，二进制处理等

## 上传文件

场景：单文件、多文件、目录上传、压缩目录上传、拖拽上传、剪贴板上传、大文件分块上传、服务端上传。

### 单文件上传

**前端代码**

```html
<input id='uploadFile' type="file" accept="image/*"/>
<button id='submit' onclick='uploadFile()'>上传文件</button>
```

其中 accept 用于限制上传文件类型。IE9 以下不支持该属性

- `image/*` 限制只能上传 image 文件
- `image/png` 限制只能上传png
- `image/png,image/jpeg` 限制只能上传png和jpg

> accept只进行限制后缀名，把后缀名更改还是可以绕过检测，而想实现只接受特定的格式，使用其他工具，或者是看这个教程 [如何区分图片类型](https://juejin.cn/post/6971935704938971173)。

**JS代码**

```js
const uploadFileEle = document.querySelector('#uploadFile')
const request = axios.create({
  baseURL:'http://localhost:8080/upload',
  timeout:60000
})
// 判断是否存在文件，获取文件，进行上传
async functioin uploadFile(){
  if(!uploadFileEle.files.length) return
  const file = uploadFileEle.files[0]
  upload({
    url:'/single',
    file
  })
}
function upload({url,file,fieldName='file'}){
  let formData = new FormData()
  formData.set(fieldName,file)
  request.post(url,formData,{
    onPuloadProgress:function(progressEvent){
      const percentCompleted = Math.round(
      (progressEvent.loaded*100)/progressEvent.total)
    }
    console.log(percentCompleted)
  })
}
```

上述代码先把读取的File对象封装成FormData对象，然后利用Axios的post实现文件上传的功能。再上传之前，通过请求配置对象的onUploadProgress 就可以获取文件的上传进度。

### 分片上传

## 应用场景

### 保存文件

```js
const onSaveFile = () => {
  const blob = new Blob([codeContext.value], { type: 'text/javascript' });
  const url = URL.createObjectURL(blob)
  const a = document.createElement("a");
  a.download = "sunshine";
  a.href = url;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}
```

### 分片上传

分片上传：对于大文件的上传，通过 slice 的方法对大文件进行切割，然后分片进行上传

```js
const file = new File(['a'.repeat(1000000)],'test.txt')
const chunkSize = 40000
const postUrl = 'https://example.web/post'
async function chunkUpload(){
  for(let start = 0;start<file.size;start+=chunkSize){
    const chunk = file.slice(start,start+chunkSize+1)
    const fd = new FormData()
    fd.append('data',chunk)
    await fetch(postUrl,{method:'post',body:fd}).then(res=>{
      res.text()
    })
  }
}
```

### 下载数据

下载数据：可以将从互联网上下载的数据存放到 Blob 对象中

```js
// 使用 XMLHttpRequest
const downloadBlob = (url,callback)=>{
  const xhr = new XMLHttpRequest()
  xhr.open('GET',url)
  xhr.responseType = 'blob'
  xhr.onload=()=>{
    callback(xhr.response)
  }
  xhr.send(null)
}
// 使用 fetch
const myImg = document.querySelector('img')
const myReq = new Request('flowers.jpg')
fetch(myReq).then(res=>{
  return response.blob()
}).then(blob=>{
  let objURL = URL.createObjectURL(blob)
  myImage.src = objURL
})
```

## 参考文章

| 作者（文章名称）                | 连接                                       |
| ------------------------------- | ------------------------------------------ |
| controZL                        | https://juejin.cn/post/6915795898609975309 |
| 阿宝哥                          | https://juejin.cn/post/6980142557066067982 |
| 你不知道的 Blob                 | http://caibaojian.com/blob.html            |
| 苏苏同学                        | https://juejin.cn/post/7046313942938812424 |
| JavaScript 如何检测文件的类型？ | https://juejin.cn/post/6971935704938971173 |

